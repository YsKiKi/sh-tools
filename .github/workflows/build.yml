name: Build and Release

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write  # Required to create tags and releases
      pull-requests: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history required for GitVersion
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install GitVersion
      uses: gittools/actions/gitversion/setup@v1.0.0
      with:
        versionSpec: '5.x'
    
    - name: Execute GitVersion
      id: gitversion
      uses: gittools/actions/gitversion/execute@v1.0.0
      with:
        useConfigFile: true
        configFilePath: 'GitVersion.yml'
    
    - name: Display version info
      shell: pwsh
      run: |
        Write-Host "Version: ${{ steps.gitversion.outputs.major }}.${{ steps.gitversion.outputs.minor }}.${{ steps.gitversion.outputs.patch }}"
        Write-Host "Full version: ${{ steps.gitversion.outputs.fullSemVer }}"
        Write-Host "Semantic version: ${{ steps.gitversion.outputs.semVer }}"
    
    - name: Install dependencies
      working-directory: ./Bili_Video
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build application
      working-directory: ./Bili_Video
      run: |
        pyinstaller --windowed --onefile --icon=icon.ico --name="A+1-Tool" --hidden-import=resources --hidden-import=download --hidden-import=m4s gui.py
    
    - name: Verify build artifacts
      working-directory: ./Bili_Video
      shell: pwsh
      run: |
        if (Test-Path dist\A+1-Tool.exe) {
          Write-Host "Build successful!"
          Get-Item dist\A+1-Tool.exe
        } else {
          Write-Host "Build failed: A+1-Tool.exe not found"
          exit 1
        }
    
    - name: Create version tag
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      shell: pwsh
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        $version = "${{ steps.gitversion.outputs.major }}.${{ steps.gitversion.outputs.minor }}.${{ steps.gitversion.outputs.patch }}"
        $tag = "v$version"
        Write-Host "Creating tag: $tag"
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        # Check if tag already exists
        $tagExists = git tag -l "$tag"
        if ($tagExists) {
          Write-Host "Tag $tag already exists, skipping creation"
        } else {
          git tag -a "$tag" -m "Version $tag"
          # Push tag using token
          $repo = "${{ github.repository }}"
          git remote set-url origin "https://$env:GITHUB_TOKEN@github.com/$repo.git"
          git push origin "$tag"
          Write-Host "Tag $tag created successfully"
        }
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: A+1-Tool-v${{ steps.gitversion.outputs.major }}.${{ steps.gitversion.outputs.minor }}.${{ steps.gitversion.outputs.patch }}
        path: |
          Bili_Video/dist/A+1-Tool.exe
          Bili_Video/dist/config.json
        retention-days: 30
    
    - name: Create Release
      if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') && github.event_name == 'push'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.gitversion.outputs.major }}.${{ steps.gitversion.outputs.minor }}.${{ steps.gitversion.outputs.patch }}
        name: Version v${{ steps.gitversion.outputs.major }}.${{ steps.gitversion.outputs.minor }}.${{ steps.gitversion.outputs.patch }}
        body: |
          ## Version v${{ steps.gitversion.outputs.major }}.${{ steps.gitversion.outputs.minor }}.${{ steps.gitversion.outputs.patch }}
          
          ### Build Information
          - Commit: ${{ github.sha }}
          - Branch: ${{ github.ref }}
          - Build Date: ${{ steps.gitversion.outputs.committedDate }}
          
          ### Download
          Please download the build artifacts from the Assets section.
        files: |
          Bili_Video/dist/A+1-Tool.exe
          Bili_Video/dist/config.json
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

